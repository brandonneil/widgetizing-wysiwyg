<!doctype html>
<html lang="en">

	<head>
		<meta charset="utf-8">

		<title>Widgetizing WYSIWYG - DrupalCorn Camp 2015</title>

		<meta name="description" content="A framework for easily creating beautiful presentations using HTML">
		<meta name="author" content="Hakim El Hattab">

		<meta name="apple-mobile-web-app-capable" content="yes" />
		<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />

		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, minimal-ui">

		<link rel="stylesheet" href="css/reveal.css">
		<link rel="stylesheet" href="css/theme/drupalcamp-color.css" id="theme">

		<!-- FontAwesome -->
		<link rel="stylesheet" href="lib/font/font-awesome-4.3.0/css/font-awesome.min.css">

		<!-- Code syntax highlighting -->
		<link rel="stylesheet" href="lib/css/zenburn.css">

		<!-- Printing and PDF exports -->
		<script>
			var link = document.createElement( 'link' );
			link.rel = 'stylesheet';
			link.type = 'text/css';
			link.href = window.location.search.match( /print-pdf/gi ) ? 'css/print/pdf.css' : 'css/print/paper.css';
			document.getElementsByTagName( 'head' )[0].appendChild( link );
		</script>

		<!--[if lt IE 9]>
		<script src="lib/js/html5shiv.js"></script>
		<![endif]-->
	</head>

	<body>

		<div class="reveal">

            <div class="footer">
                <div class="branding--logo">
                    <p class="logo__site-name">#drupalcorn</p>
                </div>
                <div class="session--info">
                    <p class="session__title">Widgetizing WYSIWYG <span class="seperator">&nbsp;/&nbsp;</span></p>
                    <p class="session__presenter">Brandon Neil</p>
                </div>
            </div>

			<!-- Any section element inside of this container is displayed as a slide -->
			<div class="slides">
                <section>
                    <h1>Widgetizing WYSIWYG</h1>
                    <h3>http://2015.drupalcorn.org/sessions/widgetizing-wysiwyg</h3>
                    <h3>Slides: <a href="http://bit.ly/drupalcorn-widgets">http://bit.ly/drupalcorn-widgets</a>
                    <h3>Code: <a href="https://github.com/brandonneil/campwidgets">https://github.com/brandonneil/campwidgets</a>
                    <h3>DrupalCorn Camp 2015</h3>
                    <h3>#drupalcorn</h3>
                </section>

                <section>
                    <h1>Brandon Neil</h1>
                    <h3><i class="fa fa-twitter"></i> <a href="http://twitter.com/brandonneil">@brandonneil</a></h3>
                    <h3><i class="fa fa-drupal"></i> <a href="https://www.drupal.org/u/bneil">bneil</a></h3>
                    <img alt="The University of Iowa" src="images/domewordsingle__convertedwhite.png" style="border:none; background: none; box-shadow: none; margin: 0; max-width: 700px;" />
                </section>
                <section>
									<h2>Widgetizing WYSIWYG</h2>
									<h3>with CKEditor 4</h3>
									<h4 class="fragment">Assumptions</h4>
									<ul>
										<li class="fragment">Have implemented <a href="https://www.drupal.org/node/292">Drupal Hooks</a></li>
										<li class="fragment">Javascript</li>
									</ul>
									<aside class="notes">
										So today we're going to talk a bit about creating widgets in
										CKEditor 4, a popular rich text editor. But before we get there, I'd like to take a step back and talk about Drupal.
									</aside>
								</section>
                <section>
                  <h2>What we're covering</h2>
                  <ul>
                    <li class="fragment">What's a widget?</li>
                    <li class="fragment">Widget examples</li>
                    <li class="fragment">Utilizing a 'contrib' widget in Drupal</li>
                    <li class="fragment">Creating our own widget</li>
                  </ul>
                </section>
								<section>
									<h2>Drupal == Structure</h2>
									<ul>
										<li class="fragment">Content types</li>
										<li class="fragment">Fields</li>
										<li class="fragment">View Modes</li>
										<li class="fragment">Image Styles</li>
									</ul>
									<aside class="notes">
										Use this slide to creat an image the same size as the next, with those list items as blobs. Drupal is all about structure. We have fields, blocks, templates, etc.
									</aside>
								</section>
                <section>
                  <h2>¯\_(ツ)_/¯</h2>
                </section>
                <section>
									<h2>Structure<span class="fragment">?</span></h2>
									<img src="images/emptybody.png" alt="Empty WYSIWYG text area" class="fragment"/>
									<aside class="notes">
										Drupal is all about structure. We have fields, blocks, templates, etc. But I've noticed that there's one place that's really hard for us to wrangle and that's this field right here.
									</aside>
								</section>
                <section>
									<h2>CKEditor 4</h2>
									<h3 class="fragment">Rich text editor</h3>
									<h3 class="fragment">What You See Is What You Get</h3>
									<ul class="fragment">
										<li>Open source</li>
										<li>Accessible</li>
										<li>Advanced Content Filter (ACF) - 4.1+</li>
										<li>Widgets - 4.3+</li>
									</ul>
									<aside class="notes">
										Explain the fun features of CKEditor 4, leaving Widgets for the next slide.
									</aside>
								</section>
								<section>
									<h2>CKEditor 4</h2>
									<h3>Rich text editor</h3>
									<h3>What You See Is What You Get</h3>
									<ul>
										<li>Open source</li>
										<li>Accessible</li>
										<li>Advanced Content Filter (ACF) - 4.1+</li>
										<li><strong>Widgets - 4.3+</strong></li>
									</ul>
									<aside class="notes">
										But what we're really here today to talk about are Widgets.
									</aside>
								</section>
								<section>
									<h2>Widgets</h2>
									<figure><blockquote>Widgets are <strong>special rich content units</strong> in that they are <strong>groups of elements</strong> which are <strong>treated as a single entity</strong> inside the editor.</blockquote><figcaption><a href="http://docs.ckeditor.com/#!/guide/dev_widgets">- CKEditor documentation</a></figcaption></figure>
								</section>
								<section>
									<h2>Characteristics of a Widget</h2>
									<ul>
										<li class="fragment">Structure is immutable</li>
										<li class="fragment">Instance can be selected as a whole and moved around freely</li>
										<li class="fragment">Individual parts can be edited</li>
										<li class="fragment">Easy to enforce consistent styling of entire widget</li>
										<li class="fragment">Can limit available elements inside of a widget</li>
									</ul>
									<aside class="notes">
									</aside>
								</section>
								<section>
									<h2>Examples</h2>
									<ul>
										<li><a href="http://ckeditor.com/addon/image2">Enhanced Image</a></li>
										<li><a href="http://ckeditor.com/addon/mathjax">Mathematical Formulas</a></li>
										<li><a href="http://ckeditor.com/addon/codesnippet">Code Snippet</a></li>
										<li><a href="http://ckeditor.com/addon/leaflet">Leaflet Maps</a></li>
                    <li><a href="http://ckeditor.com/addon/layoutmanager">Layout Manager</a></li>
									</ul>
									<aside class="notes">
									</aside>
								</section>
                <section>
                  <h2>Drupal Modules that utilize CKEditor Widgets</h2>
                  <ul>
                    <li>Drupal 8 Core</a></li>
                    <li><a href="https://www.drupal.org/project/entity_embed">Drupal 7/8: Entity Embed</a></li>
                    <li><a href="https://www.drupal.org/project/media_ckeditor">Drupal 7: Media CKEditor</a></li>
                  </ul>
                  <aside class="notes">
                  </aside>
                </section>
                <section>
                  <h1>Utilizing a 'contrib' widget in Drupal</h1>
                </section>
                <section>
                  <h2>Task: build a Drupal module that adds a plugin (Layout Manager) to CKEditor.</h2>
                </section>
                <section>
                  <h2>CKEditor widgets are plugins</h2>
                </section>
                <section>
                  <h2>Plugins can be found in the CKEditor plugin repository</h2>
                  <a href="http://ckeditor.com/addons/plugins/all">http://ckeditor.com/addons/plugins/all</a>
                  <h3 class="fragment">(or on github, etc)</h3>
                </section>
                <section>
                  <h2>Time to download things</h2>
                  <ul>
                    <li>CKEditor 4 Library</li>
                    <li>CKEditor 4 Widget Plugin</li>
                    <li>CKEditor or WYSIWYG module</li>
                  </ul>
                  <aside class="notes">
                    You'll need the CKEditor 4 javascript library and either the CKEditor module or WYSIWYG module. I'm going to use the WYSIWYG module in these examples because I'm more familiar with it, but will point out the corresponding CKEditor module hook.
                  </aside>
                </section>
                <section>
                  <h2>CKEditor Library Download</h2>
                  <p><a href="http://docs.ckeditor.com/#!/guide/dev_widget_installation">http://docs.ckeditor.com/#!/guide/dev_widget_installation</a></p>
                </section>
                <section>
                  <h3>Use CKEditor Builder</h3>
                  <p><a href="http://ckeditor.com/builder">http://ckeditor.com/builder</a></p>
                </section>
                <section>
                  <h2>WYSIWYG Module</h2>
                  <p><a href="https://drupal.org/project/wysiwyg">https://drupal.org/project/wysiwyg</a></p>
                  <p>Dev version</p>
                </section>
                <section>
                  <h1>Let's build!</h1>
                  <ul>
                    <li class="fragment">campwidgets.info</li>
                    <li class="fragment">campwidgets.module</li>
                  </ul>
                </section>
                <section>
                  <h3>campwidgets.info</h3>
                  <pre><code>name = Camp Widgets
description = Adds widgets to CKEditor

core = 7.x

dependencies[] = wysiwyg</code></pre>
                </section>
                <section>
                  <h3>campwidgets.module</h3>
                  <h4>hook_wysiwyg_plugin() or hook_ckeditor_plugin()</h4>
                </section>
                <section>
                  <h1>Creating Our Own CKEditor Widget</h1>
                  <h2 class="fragment">A simple callout</h2>
                </section>
                </section>
                <section>
                  <h2>Task: build a CKEditor Plugin that includes a widget.</h2>
                </section>
								<section>
								<h1>Dependencies</h1>
								<ul>
									<li>CKEditor 4 Library &#10004;</li>
                  <li>CKEditor 4 Widget Plugin &#10004;</li>
									<li>CKEditor or WYSIWYG module &#10004;</li>
								</ul>
								<aside class="notes">
									You'll need the CKEditor 4 javascript library and either the CKEditor module or WYSIWYG module. I'm going to use the WYSIWYG module in these examples because I'm more familiar with it, but will point out the corresponding CKEditor module hook.
								</aside>
								</section>
								<section>
									<h1>Let's build!</h1>
								</section>
								<section>
									<h2>The Drupal-y bits</h2>
								</section>

								<section>
									<h3>campwidgets.info</h3>
                  <span>(From earlier)</span>
                </section>
								<section>
									<h3>campwidgets.module</h3>
									<h4>hook_wysiwyg_plugin() or hook_ckeditor_plugin()</h4>
                </section>
								<section>
									<h2>CKEditor API</h2>
									<p>plugins/callout/plugin.js<p>
									<img src="images/directory2.png" alt="added a callout/plugin.js file"/>
								</section>
								<section>
									<h3>CKEditor docs</h3>
									<h4><a href="http://docs.ckeditor.com/#!/api/CKEDITOR.plugins-method-add">CKEDITOR.plugins-method-add</a></h4>
									<h4><a href="http://docs.ckeditor.com/#!/api/CKEDITOR.pluginDefinition">CKEDITOR.pluginDefinition</a></h4>
									<h4><a href="http://docs.ckeditor.com/#!/api/CKEDITOR.plugins.widget.repository-method-add">CKEDITOR.plugins.widget.repository-method-add</a></h4>
    							<h4><a href="http://docs.ckeditor.com/#!/api/CKEDITOR.plugins.widget.definition">CKEDITOR.plugins.widget.definition</a></h4>
								</section>
								<section>
									<h3>Add your button icon</h3>
									<img src="images/directory3.png" alt="added an icons/callout.png file"/>
									<p>16x16px and 32x32px for hidpi</p>
								</section>
								<section>
									<h3>Add default callout styling</h3>
									<ul>
										<li class="fragment">Create callout.css</li>
										<li class="fragment">Load callout.css file in the WYSIWYG</li>
										<li class="fragment">Load callout.css file on the front end</li>
									</ul>
    							<aside class="notes">Right now, the callout doesnt look that impressive. Let's add some css to make it look better.</aside>
								</section>
								<section>
									<h4>Create callout.css</h4>
									<img src="images/directory4.png" alt="Adds callout.css to the root of the module directory">
    							<aside class="notes">Let's start by creating a callout.css file with our style.</aside>
								</section>
								<section>
									<h4>Load CSS in the WYSIWYG</h4>
									<p>hook_ckeditor_settings_alter() or hook_wysiwyg_editor_settings_alter()</p>
                  <span>Let's add to our hook implementation from earlier</span>
								</section>
								<section>
									<h4>Load CSS in the front end</h4>
									<p>Add to stylesheets in campwidgets.info</p>
									<pre><code>name = Camp Widgets
description = Adds widgets to CKEditor

core = 7.x

dependencies[] = wysiwyg

stylesheets[all][] = callout.css
</code></pre>
								</section>
								<section>
									<h4>Demo</h4>
								</section>
								<section>
									<h3>Full plugin.js</h3>
									<pre><code>
CKEDITOR.plugins.add('callout', {

  requires: 'widget',

  icons: 'callout',

  init: function( editor ) {

    editor.widgets.add( 'callout', {

        button: 'Create a simple callout',

        template:
            '<div class="callout">' +
                '<div class="callout-content"><p>Callout!</p></div>' +
            '</div>',

        editables: {
            content: {
                selector: '.callout-content',
                allowedContent: 'p br ul ol li strong em'
            }
        },

        allowedContent: 'div(!callout); div(!callout-content);',

        // Required content for the widget to function. If editor does not
        // support this, the button does not function.
        requiredContent: 'div(callout)',

        upcast: function( element ) {
            return element.name == 'div' && element.hasClass( 'callout' );
        },
    });
  }
});

									</code></pre>
								</section>
								<section>
									<h2>One more thing...</h2>
									<p class="fragment">Creating a dialog for our widget</p>
									<ul class="fragment">
										<li>Set width</li>
										<li>Set alignment via a class "align-right", etc</li>
									</ul>
								</section>
								<section>
									<img src="images/dialog.png" alt="CKEditor dialog with width and alignment fields">
								</section>
								<section>
									<h3>Register the dialog window</h3>
									<pre><code>
CKEDITOR.plugins.add('callout', {
  //Existing code...

  init: function( editor ) {

    editor.widgets.add( 'callout', {
    		// Existing code...

    		// Associate the callout dialog with this widget.
        dialog: 'callout',

    });

    // Register the dialog and its path.
    CKEDITOR.dialog.add( 'callout', this.path + 'dialogs/callout.js' );
  }
});
									</code></pre>
								</section>
								<section>
									<img src="images/directory5.png" alt="added dialog directory and inside callout.js file">
								</section>
								<section>
									<h3>Create dialog callout.js file</h3>
								</section>
								<section>
									<h3>Styling - callout.css</h3>
									<pre><code>
@media all and (min-width: 600px) {
    .callout.align-right {
        float: right;
    }
    .callout.align-left {
        float: left;
    }
}
.callout.align-center {
    margin-left: auto;
    margin-right: auto;
}
									</code></pre>
								</section>
								<section>
									<h3>Alter allowedContent</h3>
									<p>We don't want our new properties filtered out</p>
									<pre><code>
editor.widgets.add( 'callout', {
    // Code before...

    // ACF allowed content.
    allowedContent: 'div(!callout,align-left,align-right,align-center){width});'+
        'div(!callout-content);',

    // Code after...
});
    							</code></pre>
    						</section>
    						<section>
    							<h3>Widget init method</h3>
    							<pre><code>
editor.widgets.add( 'callout', {
    // Code before...

    init: function() {
        var width = this.element.getStyle( 'width' );
        if ( width )
            this.setData( 'width', width );
        if ( this.element.hasClass( 'align-left' ) )
            this.setData( 'align', 'left' );
        if ( this.element.hasClass( 'align-right' ) )
            this.setData( 'align', 'right' );
        if ( this.element.hasClass( 'align-center' ) )
            this.setData( 'align', 'center' );
    }
});
    							</code></pre>
    						<aside class="notes">When a widget is being initialized we need to read its data (align and width) from DOM and set this data by using the widget.setData() method.</aside>
    						</section>
    						<section>
    							<h3>Widget data method</h3>
    							<pre><code>
editor.widgets.add( 'callout', {
    // Code before...

    data: function() {
        if ( this.data.width == '' )
            this.element.removeStyle( 'width' );
        else
            this.element.setStyle( 'width', this.data.width );

        this.element.removeClass( 'align-left' );
        this.element.removeClass( 'align-right' );
        this.element.removeClass( 'align-center' );
        if ( this.data.align )
            this.element.addClass( 'align-' + this.data.align );
    }
});
    							</code></pre>
    							<aside class="notes">The function we are going to define in the data property of the widget definition will be executed every time the widget data is changed. Widget data will be changed by using the widget.setData() method, which we previously added to commit functions of the dialog window fields.</aside>
    						</section>
    						<section>
    							<h3>Final plugin.js code</h3>
    							<pre><code>
CKEDITOR.plugins.add('callout', {

  // CKEditor plugin dependencies.
  requires: 'widget',

  // Icon file name. callout.png.
  icons: 'callout',

  // Plugin initialization method.
  init: function( editor ) {

    // Register our callout widget.
    editor.widgets.add( 'callout', {
        // Button text on hover state.
        button: 'Create a simple callout',

        // The widget template.
        template:
            '<div class="callout">' +
                '<div class="callout-content"><p>Callout!</p></div>' +
            '</div>',

        // Widget editable areas.
        editables: {
            content: {
                selector: '.callout-content',
                allowedContent: 'p br ul ol li strong em'
            }
        },

        // ACF allowed content.
        allowedContent: 'div(!callout,align-left,align-right,align-center){width});'+
            'div(!callout-content);',

        // Required content for the widget to function. If editor does not
        // support this, the button does not function.
        requiredContent: 'div(callout)',

        // Function to determin if an element is a widget.
        upcast: function( element ) {
            return element.name == 'div' && element.hasClass( 'callout' );
        },

        dialog: 'callout',

        init: function() {
            var width = this.element.getStyle( 'width' );
            if ( width )
                this.setData( 'width', width );
            if ( this.element.hasClass( 'align-left' ) )
                this.setData( 'align', 'left' );
            if ( this.element.hasClass( 'align-right' ) )
                this.setData( 'align', 'right' );
            if ( this.element.hasClass( 'align-center' ) )
                this.setData( 'align', 'center' );
        },

        data: function() {
            if ( this.data.width == '' )
                this.element.removeStyle( 'width' );
            else
                this.element.setStyle( 'width', this.data.width );

            this.element.removeClass( 'align-left' );
            this.element.removeClass( 'align-right' );
            this.element.removeClass( 'align-center' );
            if ( this.data.align )
                this.element.addClass( 'align-' + this.data.align );
        }
    });
    CKEDITOR.dialog.add( 'callout', this.path + 'dialogs/callout.js' );
  }
});

    							</code></pre>
    						</section>
								<section>
									<h2>Another thing...</h2>
									<p class="fragment">Widget-based styles</p>
								</section>
								<section>
									<h2>Widget-based styles</h2>
									<img src="images/styles.png" alt="CKEditor styles dropdown for a widget"/>
									<p>Creation of widget-only style options in the "Styles" dropdown</p>
								</section>
								<section>
									<h3>CSS - callout.css</h3>
									<pre><code>
.primary {;
  font-size: 1.2em;
  line-height: 1.3em;
  font-weight: 400;
  background-color: #F2F2F2;
  border: none;
  border-top: 1px solid #DFDFDF;
  border-bottom: 1px solid #DFDFDF;
}

.callout.fancy {
    padding: 8px;
    margin: 10px;
    background: #eee;
    border-radius: 8px;
    border: 1px solid #ddd;
    box-shadow: 0 1px 1px #fff inset, 0 -1px 0px #ccc inset;
    max-width: 100%;
    min-width: 200px;
}

.fancy .callout-content {
    box-shadow: 0 1px 1px #ddd inset;
    border: 1px solid #cccccc;
    border-radius: 5px;
    background: #fff;
    padding: 8px;
}
									</code></pre>
								</section>
																<section>
									<h3>Modify CKEditor styleSet array</h3>
									<pre><code>
/**
 * Implements hook_wysiwyg_editor_settings_alter().
 */
function campwidgets_wysiwyg_editor_settings_alter(&$settings, $context) {
  // Check if the editor is CKEditor.
  if ($context['profile']->editor == 'ckeditor') {

    $settings['layoutmanager_loadbootstrap'] = TRUE;

    // Get module path.
    $module_location = $GLOBALS['base_path'] . drupal_get_path('module', 'campwidgets');

    // Include custom css files.
    $settings['contentsCss'][] = $module_location . '/callout.css';

    // Define fancy style set.
    $style_fancy = array(
      'name' => 'Fancy',
      'type' => 'widget',
      'widget' => 'callout',
      'attributes' => array(
        'class' => 'fancy'
      )
    );

    // Define primary style set.
    $style_primary = array(
      'name' => 'Primary',
      'type' => 'widget',
      'widget' => 'callout',
      'attributes' => array(
        'class' => 'primary'
      )
    );

    $settings['stylesSet'][] = $style_fancy;
    $settings['stylesSet'][] = $style_primary;
  }
}
									</code></pre>
									<p><a href="http://docs.ckeditor.com/#!/guide/dev_styles-section-widget-styles">CKEditor docs: widget styles</a></p>
								</section>
								<section>
									<h2>Resources</h2>
									<ul>
										<li>Les Lim: <a href="http://2014.tcdrupal.org/session/help-your-wysiwyg-help-you-creating-custom-ckeditor-widgets">Help your WYSIWYG help you: Creating custom CKEditor Widgets</a></li>
										<li>CKEditor Documentation: <a href="http://docs.ckeditor.com/#!/guide/widget_sdk_tutorial_1">Creating a Simple CKEditor Widget</a></li>
									</ul>
								</section>
								<section>
									<h2>Questions?</h2>
								</section>
                <section>
                    <h1>Feedback</h1>
                    <h3>https://2015.drupalcorn.org/evaluation</h3>
                </section>



			</div>

		</div>

		<script src="lib/js/head.min.js"></script>
		<script src="js/reveal.js"></script>

		<script>

			// Full list of configuration options available at:
			// https://github.com/hakimel/reveal.js#configuration
			Reveal.initialize({
				controls: true,
				progress: true,
				history: true,
				center: true,

				transition: 'none', // none/fade/slide/convex/concave/zoom

				// Optional reveal.js plugins
				dependencies: [
					{ src: 'lib/js/classList.js', condition: function() { return !document.body.classList; } },
					{ src: 'plugin/markdown/marked.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
					{ src: 'plugin/markdown/markdown.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
					{ src: 'plugin/highlight/highlight.js', async: true, condition: function() { return !!document.querySelector( 'pre code' ); }, callback: function() { hljs.initHighlightingOnLoad(); } },
					{ src: 'plugin/zoom-js/zoom.js', async: true },
					{ src: 'plugin/notes/notes.js', async: true }
				]
			});

		</script>

	</body>
</html>
